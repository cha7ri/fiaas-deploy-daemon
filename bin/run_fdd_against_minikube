#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

export NAMESPACE="${NAMESPACE:-default}"
KUBECONFIG_JSON="$(kubectl config view -o json)"
export KUBECONFIG_JSON
API_SERVER="$(jq -r '.clusters[] | select(.name == "minikube") | .cluster.server' <<< "$KUBECONFIG_JSON")"
CLIENT_CERT="$(jq -r '.users[] | select(.name == "minikube") | .user."client-certificate"' <<< "$KUBECONFIG_JSON")"
CLIENT_KEY="$(jq -r '.users[] | select(.name == "minikube") | .user."client-key"' <<< "$KUBECONFIG_JSON")"
ARGS=(
'--debug'
'--api-server' "$API_SERVER"
'--client-cert' "$CLIENT_CERT"
'--client-key' "$CLIENT_KEY"
'--service-type' 'ClusterIP'
'--ingress-suffix' "xip.io"
'--environment' 'test'
'--datadog-container-image' 'datadog/docker-dd-agent:12.2.5172-alpine'
'--enable-crd-support'
#'--tls-certificate-issuer-type-overrides' "$(minikube ip).int.xip.io=cert-manager.k8s.io/issuer"
'--use-ingress-tls' 'default_on'
#'--tls-certificate-issuer' "letsencrypt-prod"
#'--disable-tls-for-domain-suffixes' 'int.xip.io'
'--tls-certificate-issuer-disable-for-domain-suffixes' 'xip.io'
'--tls-certificate-issuer-disable-for-domain-suffixes' 'foo.example.com'

)

(set -x; fiaas-deploy-daemon "${ARGS[@]}")
